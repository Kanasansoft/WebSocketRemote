<!doctype html>
<html>
<head>
<style>
body{overflow:hidden;margin:0px;}
</style>
<script>
var browser;
var remote;
var webSocket;
//var receiveData;
var receiveIndexes=[];
var receiveData={};
function scrollDisplay(eve){
//var x=eve.x/remote.offsetWidth*(remote.offsetWidth-browser.clientWidth);
//var y=eve.y/remote.offsetHeight*browser.clientHeight;
var x=eve.x/browser.clientWidth*(remote.offsetWidth-browser.clientWidth);
var y=eve.y/browser.clientHeight*(remote.offsetHeight-browser.clientHeight);
console.log(document.compatMode,eve.x,browser.clientWidth,remote.offsetWidth,eve.y,browser.clientHeight,remote.offsetHeight);
scrollTo(x,y);
}
function getMessage(message){
//	console.log(message.data.length);
//	remote.src="data:image/png;base64,"+message.data;
/*
	var data=message.data;
	while(data.length!=0){
		var startPosition=data.indexOf("^");
		var endPosition=data.indexOf("$");
		if(startPosition==-1){
			startPosition=Number.POSITIVE_INFINITY;
		}
		if(endPosition==-1){
			endPosition=Number.POSITIVE_INFINITY;
		}
		if(Math.min(startPosition,endPosition)==Number.POSITIVE_INFINITY){
			receiveData+=data;
			data="";
		}else if(startPosition<endPosition){
			receiveData="";
			data=data.slice(startPosition+1);
		}else if(startPosition>endPosition){
			receiveData+=data.slice(0,endPosition);
			data=data.slice(endPosition+1);
			var separatorPosition=receiveData.indexOf("_");
			if(separatorPosition!=-1){
				var dataLength=parseInt(receiveData.slice(0,separatorPosition),16);
				var base64=receiveData.slice(separatorPosition+1);
				if(dataLength==base64.length){
					remote.src="data:image/png;base64,"+base64;
				}
			}
//			console.log("+++"+receiveData.length);
			data="";
		}
	}
*/
	var data=message.data;
	var splitData=data.split("_");
	if(splitData.length!=4){
		return;
	}
	var imageId=splitData[0];
	var sequenceNumber=parseInt(splitData[1],16);
	var sequenceCount=parseInt(splitData[2],16);
	if(receiveIndexes.indexOf(imageId)==-1){
		receiveIndexes.push(imageId);
		receiveIndexes.sort(function(a,b){return parseInt(a,16)-parseInt(b,16);});
		receiveData[imageId]={"data":[],"receiveCount":0,"sequenceCount":sequenceCount};
	}
	var receive=receiveData[imageId];
	receive.receiveCount++;
	receive.data[sequenceNumber]=splitData[3];
	if(receive.receiveCount!=receive.sequenceCount){
		return;
	}
	var currentPosition=receiveIndexes.indexOf(imageId);
	deleteIndexes=receiveIndexes.slice(0,currentPosition+1);
	receiveIndexes=receiveIndexes.slice(currentPosition+2);
	for(var i=0;i<deleteIndexes.length;i++){
		delete receiveData[deleteIndexes[i]];
	}
	var base64="";
	for(var i=1;i<receive.data.length;i++){
		base64+=receive.data[i];
	}
	remote.setAttribute("src","data:image/jpg;base64,"+base64);
}
function onUnload(){
	webSocket.close();
}
function initial(eve){
	browser=document.documentElement;
	remote=document.getElementById("remote");
	browser.addEventListener("mousemove",scrollDisplay,false);
	var protocol=(location.protocol=="https:")?"wss":"ws";
	var host=location.host;
	console.log(protocol+"://"+host+"/");
	webSocket=new WebSocket(protocol+"://"+host+"/ws/");
	webSocket.addEventListener("message",getMessage,false);
	window.addEventListener("unload",onUnload,false);
}
window.addEventListener("load",initial,false);
</script>
</head>
<body>
<img id="remote" src="images/splash.png" />
</body>
</html>
